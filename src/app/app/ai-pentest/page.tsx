"use client";

import { useState, useMemo } from "react";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import {
  faRobot,
  faPlus,
  faPlay,
  faCheck,
  faTimes,
  faClock,
  faSpinner,
  faChevronRight,
  faSearch,
} from "@fortawesome/free-solid-svg-icons";
import DashboardLayout from "@/components/dashboard/DashboardLayout";
import { useAuth } from "@/lib/context/AuthContext";
import { useUserData } from "@/lib/hooks/useUserData";
import { auth, db } from "@/lib/firebase/firebaseClient";
import {
  collection,
  query,
  where,
  orderBy,
  limit,
  onSnapshot,
} from "firebase/firestore";
import { useEffect } from "react";

interface AIPentestRun {
  id: string;
  name: string;
  status: "queued" | "running" | "completed" | "failed" | "cancelled";
  targets: string[];
  scanTypes: string[];
  progress: {
    total: number;
    completed: number;
    failed: number;
  };
  startTime: any;
  endTime?: any;
  summary?: {
    targetsScanned: number;
    findingsCount: number;
    criticalCount: number;
    highCount: number;
  };
}

const statusConfig = {
  queued: { icon: faClock, color: "text-gray-600", bg: "bg-gray-100" },
  running: { icon: faSpinner, color: "text-blue-600", bg: "bg-blue-100" },
  completed: { icon: faCheck, color: "text-green-600", bg: "bg-green-100" },
  failed: { icon: faTimes, color: "text-red-600", bg: "bg-red-100" },
  cancelled: { icon: faTimes, color: "text-gray-600", bg: "bg-gray-100" },
};

export default function AIPentestPage() {
  const { currentUser } = useAuth();
  const { userData } = useUserData();
  const [runs, setRuns] = useState<AIPentestRun[]>([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");

  // Form state
  const [name, setName] = useState("");
  const [targets, setTargets] = useState("");
  const [selectedScanners, setSelectedScanners] = useState<string[]>(["nmap"]);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Fetch AI pentest runs
  useEffect(() => {
    if (!currentUser?.uid) {
      setRuns([]);
      setLoading(false);
      return;
    }

    const q = query(
      collection(db, "aiPentestRuns"),
      where("userId", "==", currentUser.uid),
      orderBy("createdAt", "desc"),
      limit(50)
    );

    const unsubscribe = onSnapshot(
      q,
      (snapshot) => {
        const runList: AIPentestRun[] = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        })) as AIPentestRun[];
        setRuns(runList);
        setLoading(false);
      },
      (err) => {
        console.error("Error fetching AI pentest runs:", err);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [currentUser?.uid]);

  const filteredRuns = runs.filter((run) =>
    run.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    run.targets.some((t) => t.toLowerCase().includes(searchTerm.toLowerCase()))
  );

  const credits = useMemo(() => {
    const limits = userData?.scannerLimits || { nmap: 0, openvas: 0, zap: 0 };
    const used = userData?.scannersUsedThisMonth || { nmap: 0, openvas: 0, zap: 0 };
    return {
      nmap: Math.max(0, (limits.nmap || 0) - (used.nmap || 0)),
      openvas: Math.max(0, (limits.openvas || 0) - (used.openvas || 0)),
      zap: Math.max(0, (limits.zap || 0) - (used.zap || 0)),
    };
  }, [userData]);

  const toggleScanner = (scanner: string) => {
    setSelectedScanners((prev) => {
      if (prev.includes(scanner)) {
        if (prev.length === 1) return prev; // Keep at least one
        return prev.filter((s) => s !== scanner);
      }
      return [...prev, scanner];
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!currentUser) return;

    setSubmitting(true);
    setError(null);

    try {
      const token = await auth.currentUser?.getIdToken();
      const targetList = targets
        .split("\n")
        .map((t) => t.trim())
        .filter((t) => t);

      if (targetList.length === 0) {
        throw new Error("Please enter at least one target");
      }

      const response = await fetch("/api/ai-pentest", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          name: name || `AI Pentest - ${new Date().toLocaleDateString()}`,
          targets: targetList,
          scanTypes: selectedScanners,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Failed to start AI pentest");
      }

      setShowModal(false);
      resetForm();
    } catch (err: any) {
      setError(err.message);
    } finally {
      setSubmitting(false);
    }
  };

  const resetForm = () => {
    setName("");
    setTargets("");
    setSelectedScanners(["nmap"]);
    setError(null);
  };

  const formatTimestamp = (timestamp: any) => {
    if (!timestamp) return "-";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString() + " " + date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  };

  return (
    <DashboardLayout>
      <div className="p-6 lg:p-8 space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">AI Pentest</h1>
            <p className="text-gray-500 mt-1">
              Automated multi-scanner pentesting workflows
            </p>
          </div>
          <button
            onClick={() => setShowModal(true)}
            className="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors"
          >
            <FontAwesomeIcon icon={faRobot} className="w-4 h-4" />
            New AI Pentest
          </button>
        </div>

        {/* Credits */}
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-600">Nmap Credits</span>
              <span className="text-xl font-bold text-cyan-600">{credits.nmap}</span>
            </div>
          </div>
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-600">OpenVAS Credits</span>
              <span className="text-xl font-bold text-orange-600">{credits.openvas}</span>
            </div>
          </div>
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-600">ZAP Credits</span>
              <span className="text-xl font-bold text-green-600">{credits.zap}</span>
            </div>
          </div>
        </div>

        {/* Search */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div className="relative">
            <FontAwesomeIcon
              icon={faSearch}
              className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"
            />
            <input
              type="text"
              placeholder="Search AI pentest runs..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
            />
          </div>
        </div>

        {/* Runs List */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-200">
          {loading ? (
            <div className="p-8 text-center text-gray-500">Loading...</div>
          ) : filteredRuns.length === 0 ? (
            <div className="p-8 text-center">
              <FontAwesomeIcon
                icon={faRobot}
                className="w-12 h-12 text-gray-300 mb-4"
              />
              <h3 className="text-lg font-medium text-gray-900">
                No AI pentest runs yet
              </h3>
              <p className="text-gray-500 mt-1">
                Start an automated pentest to scan multiple targets.
              </p>
              <button
                onClick={() => setShowModal(true)}
                className="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors"
              >
                <FontAwesomeIcon icon={faRobot} className="w-4 h-4" />
                Start AI Pentest
              </button>
            </div>
          ) : (
            <div className="divide-y divide-gray-100">
              {filteredRuns.map((run) => {
                const config = statusConfig[run.status];
                const progressPercent =
                  run.progress.total > 0
                    ? Math.round((run.progress.completed / run.progress.total) * 100)
                    : 0;

                return (
                  <div
                    key={run.id}
                    className="p-4 hover:bg-gray-50 transition-colors cursor-pointer"
                  >
                    <div className="flex items-center justify-between gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-3">
                          <div className={`p-2 rounded-lg ${config.bg}`}>
                            <FontAwesomeIcon
                              icon={config.icon}
                              className={`w-4 h-4 ${config.color} ${run.status === "running" ? "animate-spin" : ""}`}
                            />
                          </div>
                          <div>
                            <h4 className="font-medium text-gray-900">
                              {run.name}
                            </h4>
                            <div className="flex items-center gap-4 mt-1 text-sm text-gray-500">
                              <span>{run.targets.length} target(s)</span>
                              <span>{run.scanTypes.join(", ")}</span>
                            </div>
                          </div>
                        </div>

                        {run.status === "running" && (
                          <div className="mt-3">
                            <div className="flex items-center justify-between text-sm mb-1">
                              <span className="text-gray-600">Progress</span>
                              <span className="font-medium">{progressPercent}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div
                                className="bg-purple-600 h-2 rounded-full transition-all"
                                style={{ width: `${progressPercent}%` }}
                              />
                            </div>
                          </div>
                        )}
                      </div>

                      <div className="text-right text-sm text-gray-500">
                        <div>{formatTimestamp(run.startTime)}</div>
                        {run.summary && (
                          <div className="mt-1">
                            <span className="text-red-600 font-medium">
                              {run.summary.criticalCount || 0} critical
                            </span>
                            {" · "}
                            <span className="text-orange-600 font-medium">
                              {run.summary.highCount || 0} high
                            </span>
                          </div>
                        )}
                      </div>

                      <FontAwesomeIcon
                        icon={faChevronRight}
                        className="w-4 h-4 text-gray-400"
                      />
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      {/* New AI Pentest Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <form onSubmit={handleSubmit}>
              <div className="p-6 border-b border-gray-200">
                <h2 className="text-xl font-bold text-gray-900">
                  Start AI Pentest
                </h2>
                <p className="text-gray-500 mt-1">
                  Automated scanning of multiple targets
                </p>
              </div>

              <div className="p-6 space-y-4">
                {error && (
                  <div className="p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">
                    {error}
                  </div>
                )}

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Name (optional)
                  </label>
                  <input
                    type="text"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="e.g., Q1 External Assessment"
                    className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Targets (one per line) *
                  </label>
                  <textarea
                    value={targets}
                    onChange={(e) => setTargets(e.target.value)}
                    required
                    rows={5}
                    placeholder="192.168.1.1&#10;example.com&#10;https://app.example.com"
                    className="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Scan Types *
                  </label>
                  <div className="grid grid-cols-3 gap-3">
                    <button
                      type="button"
                      onClick={() => toggleScanner("nmap")}
                      className={`p-3 rounded-lg border-2 text-center transition-colors ${
                        selectedScanners.includes("nmap")
                          ? "border-cyan-500 bg-cyan-50 text-cyan-700"
                          : "border-gray-200 hover:border-gray-300"
                      }`}
                    >
                      <div className="font-medium">Nmap</div>
                      <div className="text-xs text-gray-500">{credits.nmap} credits</div>
                    </button>
                    <button
                      type="button"
                      onClick={() => toggleScanner("openvas")}
                      className={`p-3 rounded-lg border-2 text-center transition-colors ${
                        selectedScanners.includes("openvas")
                          ? "border-orange-500 bg-orange-50 text-orange-700"
                          : "border-gray-200 hover:border-gray-300"
                      }`}
                    >
                      <div className="font-medium">OpenVAS</div>
                      <div className="text-xs text-gray-500">{credits.openvas} credits</div>
                    </button>
                    <button
                      type="button"
                      onClick={() => toggleScanner("zap")}
                      className={`p-3 rounded-lg border-2 text-center transition-colors ${
                        selectedScanners.includes("zap")
                          ? "border-green-500 bg-green-50 text-green-700"
                          : "border-gray-200 hover:border-gray-300"
                      }`}
                    >
                      <div className="font-medium">ZAP</div>
                      <div className="text-xs text-gray-500">{credits.zap} credits</div>
                    </button>
                  </div>
                </div>

                <div className="bg-gray-50 rounded-lg p-4 text-sm">
                  <div className="font-medium text-gray-700 mb-1">Estimated Usage</div>
                  <div className="text-gray-600">
                    {targets.split("\n").filter((t) => t.trim()).length || 0} targets ×{" "}
                    {selectedScanners.length} scan type(s) ={" "}
                    <span className="font-medium">
                      {(targets.split("\n").filter((t) => t.trim()).length || 0) *
                        selectedScanners.length}{" "}
                      total scans
                    </span>
                  </div>
                </div>
              </div>

              <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                <button
                  type="button"
                  onClick={() => {
                    setShowModal(false);
                    resetForm();
                  }}
                  className="px-4 py-2 text-gray-700 font-medium hover:bg-gray-100 rounded-lg transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={submitting}
                  className="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50"
                >
                  {submitting ? "Starting..." : "Start AI Pentest"}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </DashboardLayout>
  );
}
