"use client";

export const runtime = 'edge';

import { useAuth } from "@/lib/context/AuthContext";
import { useUserScans } from "@/lib/hooks/useUserScans";
import DashboardLayout from "@/components/dashboard/DashboardLayout";
import Link from "next/link";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import {
  faShieldHalved,
  faGlobe,
  faServer,
  faPlus,
  faCircleNotch,
  faCheckCircle,
  faHourglass,
  faXmark,
  faClock,
} from "@fortawesome/free-solid-svg-icons";

function StatusBadge({ status }: { status: string }) {
  const map: Record<string, { label: string; icon: any; cls: string }> = {
    pending: {
      label: "Queued",
      icon: faClock,
      cls: "bg-gray-500/20 text-gray-300 border-gray-500/30",
    },
    in_progress: {
      label: "Running",
      icon: faCircleNotch,
      cls: "bg-blue-500/20 text-blue-300 border-blue-500/30",
    },
    completed: {
      label: "Completed",
      icon: faCheckCircle,
      cls: "bg-green-500/20 text-green-300 border-green-500/30",
    },
    failed: {
      label: "Failed",
      icon: faXmark,
      cls: "bg-red-500/20 text-red-300 border-red-500/30",
    },
  };
  const s = map[status] ?? map.pending;
  return (
    <span
      className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold border ${s.cls}`}
    >
      <FontAwesomeIcon
        icon={s.icon}
        className={status === "in_progress" ? "animate-spin" : ""}
      />
      {s.label}
    </span>
  );
}

function formatDate(ts: any): string {
  if (!ts) return "—";
  const d = ts?.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

export default function PentestsPage() {
  const { currentUser } = useAuth();
  const { scans, loading } = useUserScans(currentUser?.uid ?? null);

  return (
    <DashboardLayout>
      <div className="max-w-5xl mx-auto p-6 lg:p-8">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-4xl font-bold text-white mb-1">Pentests</h1>
            <p className="text-gray-400">All your penetration test jobs</p>
          </div>
          <Link
            href="/app/new-pentest"
            className="flex items-center gap-2 px-5 py-3 bg-[#4590e2] hover:bg-[#3a7bc8] text-white font-semibold rounded-lg transition-colors"
          >
            <FontAwesomeIcon icon={faPlus} />
            New Pentest
          </Link>
        </div>

        {/* Loading */}
        {loading && (
          <div className="flex items-center justify-center py-24 text-gray-500">
            <FontAwesomeIcon icon={faCircleNotch} className="animate-spin text-3xl mr-3" />
            Loading…
          </div>
        )}

        {/* Empty state */}
        {!loading && scans.length === 0 && (
          <div className="bg-white/5 border border-white/10 rounded-xl p-16 text-center">
            <div className="inline-flex p-4 rounded-full bg-white/5 mb-4">
              <FontAwesomeIcon icon={faShieldHalved} className="text-5xl text-gray-500" />
            </div>
            <h3 className="text-xl font-bold text-white mb-2">No pentests yet</h3>
            <p className="text-gray-400 mb-6">
              Launch your first AI-powered penetration test to get started.
            </p>
            <Link
              href="/app/new-pentest"
              className="inline-flex items-center gap-2 px-6 py-3 bg-[#4590e2] hover:bg-[#3a7bc8] text-white font-semibold rounded-lg transition-colors"
            >
              <FontAwesomeIcon icon={faPlus} />
              Launch First Pentest
            </Link>
          </div>
        )}

        {/* List */}
        {!loading && scans.length > 0 && (
          <div className="space-y-3">
            {scans.map((scan: any) => (
              <div
                key={scan.scanId}
                className="bg-white/5 hover:bg-white/[0.08] border border-white/10 hover:border-[#4590e2]/30 rounded-xl p-5 transition-all"
              >
                <div className="flex items-center justify-between gap-4">
                  {/* Icon + info */}
                  <div className="flex items-center gap-4 min-w-0">
                    <div className="p-2.5 rounded-lg bg-[#4590e2]/15 border border-[#4590e2]/30 flex-shrink-0">
                      <FontAwesomeIcon
                        icon={scan.type === "web_app" ? faGlobe : faServer}
                        className="text-[#4590e2]"
                      />
                    </div>
                    <div className="min-w-0">
                      <p className="text-white font-semibold truncate">{scan.target}</p>
                      <p className="text-xs text-gray-500 mt-0.5">
                        {scan.type === "web_app" ? "Web Application" : "External IP"} ·{" "}
                        {formatDate(scan.startTime)}
                      </p>
                    </div>
                  </div>

                  {/* Right: status + button */}
                  <div className="flex items-center gap-3 flex-shrink-0">
                    <StatusBadge status={scan.status} />
                    <Link
                      href={`/app/pentests/${scan.scanId}`}
                      className="px-4 py-2 bg-[#4590e2]/20 hover:bg-[#4590e2]/30 text-[#4590e2] font-semibold rounded-lg border border-[#4590e2]/30 transition-colors text-sm"
                    >
                      View
                    </Link>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </DashboardLayout>
  );
}
