import { NextRequest, NextResponse } from 'next/server';
import { adminDb } from '@/lib/firebase/firebaseAdmin';
import { FieldValue, Transaction } from 'firebase-admin/firestore';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { type, targetUrl, userRoles, endpoints, additionalContext, userId } = body;

    if (!userId) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    if (!type || !targetUrl) {
      return NextResponse.json(
        { error: 'Missing required fields' },
        { status: 400 }
      );
    }

    // Verify user has credits
    const userRef = adminDb.collection('users').doc(userId);
    const userDoc = await userRef.get();
    
    if (!userDoc.exists) {
      return NextResponse.json(
        { error: 'User not found' },
        { status: 404 }
      );
    }

    const userData = userDoc.data();
    const credits = userData?.credits || {};
    const creditType = type === 'web_app' ? 'web_app' : 'external_ip';
    const availableCredits = credits[creditType] || 0;

    if (availableCredits < 1) {
      return NextResponse.json(
        { error: 'Insufficient credits' },
        { status: 402 }
      );
    }

    // Create pentest document
    const pentestRef = adminDb.collection('pentests').doc();
    const pentestData = {
      id: pentestRef.id,
      userId,
      type,
      targetUrl,
      userRoles: userRoles || null,
      endpoints: endpoints || null,
      additionalContext: additionalContext || null,
      status: 'pending',
      createdAt: FieldValue.serverTimestamp(),
      updatedAt: FieldValue.serverTimestamp(),
      results: null,
      vulnerabilities: [],
      completedAt: null,
    };

    // Use transaction to deduct credit and create pentest atomically
    await adminDb.runTransaction(async (transaction: Transaction) => {
      // Deduct credit
      transaction.update(userRef, {
        [`credits.${creditType}`]: FieldValue.increment(-1),
      });

      // Create pentest
      transaction.set(pentestRef, pentestData);
    });

    // TODO: Trigger Claude agent to start pentest
    // This would involve calling your Claude API integration

    return NextResponse.json({
      pentestId: pentestRef.id,
      message: 'Pentest started successfully',
    });
  } catch (error: any) {
    console.error('Error creating pentest:', error);
    return NextResponse.json(
      { error: error.message || 'Internal server error' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const userId = searchParams.get('userId');

    if (!userId) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    // Get user's pentests
    const pentestsSnapshot = await adminDb
      .collection('pentests')
      .where('userId', '==', userId)
      .orderBy('createdAt', 'desc')
      .limit(50)
      .get();

    const pentests = pentestsSnapshot.docs.map((doc: any) => ({
      id: doc.id,
      ...doc.data(),
    }));

    return NextResponse.json({ pentests });
  } catch (error: any) {
    console.error('Error fetching pentests:', error);
    return NextResponse.json(
      { error: error.message || 'Internal server error' },
      { status: 500 }
    );
  }
}
